          const crops = JSON.parse(jsonStr) as MarketItem[];
          
          if (Array.isArray(crops)) {
            return crops.map((crop: MarketItem) => ({
              ...crop,
              // Ensure history is generated if missing (AI doesn't return history)
              history: crop.history || generateHistory(crop.current || crop.avg),
              // Ensure current price exists
              current: crop.current || Math.round(crop.avg + (Math.random() * 100 - 50))
            }));
          }
        }
      }
      
      console.log("AI response invalid or empty, using fallback");
      return fallbackCrops;

    } catch (error) {
      console.error("Error fetching market prices:", error);
      return fallbackCrops;
    }
  },
});
