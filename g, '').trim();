          const crops = JSON.parse(jsonStr) as MarketItem[];
          
          // Add history to AI results if missing
          return crops.map((crop: MarketItem) => ({
            ...crop,
            history: crop.history && crop.history.length > 0 ? crop.history : generateHistory(crop.avg)
          }));
        }
      }
      // If AI returns success but no content/bad format, return fallback
      console.log("AI response invalid, using fallback");
      return fallbackCrops;
    } catch (error) {
      console.error("Error fetching market prices:", error);
      return fallbackCrops;
    }
  },
});
